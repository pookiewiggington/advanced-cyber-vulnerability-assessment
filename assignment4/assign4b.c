#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <time.h>
#include <stdio.h>
#include <sys/types.h>
#include <string.h>
#include <signal.h>
#include <stdint.h>

typedef struct _item {
   struct _item *next;
   struct _item *prev;
   char data[0];
} item;   

item *items;

char WELCOME[] = "Welcome to the simple inventory manager (0.2)!\n";

void menu() {
   fprintf(stderr, "1) Add item\n");
   fprintf(stderr, "2) Remove item\n");
   fprintf(stderr, "3) List items\n");
   fprintf(stderr, "4) Edit item\n");
   fprintf(stderr, "5) Load items\n");
   fprintf(stderr, "6) Save items\n");
   fprintf(stderr, "7) Quit\n");
}

char *_fgets(char *line, size_t size, FILE *f) {
   char ch;
   int fd = fileno(f);
   int count = 0;
   line--;
   while ((read(fd, &ch, 1)) == 1) {
      count++;
      if (ch == '\n') {
         break;
      }
      line[count] = ch;
   }
   if (count) {
      line[count] = 0;
   }
   line++;
   return count ? line : NULL;
}

void add() {
   char data[256];
   size_t size;
   char ch;
   fprintf(stderr, "How long is the item info? ");
   scanf("%zu", &size);
   item *temp = (item*)malloc(sizeof(item) + size);
   fprintf(stderr, "Enter new item (upc,name,make,model,year)\n");
   _fgets(temp->data, size, stdin);
   temp->next = temp->prev = NULL;
   item *n, *p = NULL;
   for (n = items; n; n = n->next) {
      if (strcmp(temp->data, n->data) <= 0) {
         temp->next = n;
         n->prev = temp;
         break;
      }
      p = n;
   }
   if (p == NULL) {
      items = temp;
   }
   else {
      p->next = temp;
      temp->prev = p;
   }
}

void edit() {
   char data[256];
   item *n;
   fprintf(stderr, "Enter upc to edit\n");
   if (scanf("%256s", data) == 1) {
      char *lf = strchr(data, '\n');
      if (lf) {
         *lf = 0;
      }
      for (n = items; n; n = n->next) {
         if (strncmp(n->data, data, strlen(data)) == 0) {
            fprintf(stderr, "Enter new item info (upc,name,make,model,year)\n");
            _fgets(n->data, sizeof(data), stdin);
            break;
         }
      }
      if (n == NULL) {
         fprintf(stderr, "Failed to find item\n");
      }            
   }
}

void delete() {
   char data[256];
   item *n;
   fprintf(stderr, "Enter upc to delete\n");
   if (fgets(data, sizeof(data), stdin)) {
      char *lf = strchr(data, '\n');
      if (lf) {
         *lf = 0;
      }
      for (n = items; n; n = n->next) {
         if (strncmp(n->data, data, strlen(data)) == 0) {
            if (n == items) {
               items = n->next;
               if (items) {
                  if (items->prev != n) {
                     fprintf(stderr, "Corruption detected, quitting\n");
                     exit(1);
                  }
                  items->prev = NULL;
               }
            }
            else {
               if (n->prev) {
                  if (n->prev->next != n) {
                     fprintf(stderr, "Corruption detected, quitting\n");
                     exit(1);
                  }
                  n->prev->next = n->next;
               }
               if (n->next) {
                  if (n->next->prev != n) {
                     fprintf(stderr, "Corruption detected, quitting\n");
                     exit(1);
                  }
                  n->next->prev = n->prev;
               }
            }
            free(n);
            break;
         }
      }
   }
}

void display() {
   item *n;
   for (n = items; n; n = n->next) {
      fprintf(stderr, "%s\n", n->data);
   }
}

void save() {
   char data[256];
   item *n;
   fprintf(stderr, "Enter save file name\n");
   if (fgets(data, sizeof(data), stdin)) {
      char *lf = strchr(data, '\n');
      if (lf) {
         *lf = 0;
      }
      FILE *of = fopen(data, "w");
      if (of) {
         for (n = items; n; n = n->next) {
            fprintf(of, "%s\n", n->data);
         }
         fclose(of);
      }
      else {
         fprintf(stderr, "Failed to open file %s\n", data);
      }
   }
}

void load() {
   char data[256];
   size_t sz;
   char *line;
   item *n, *temp, *p;
   fprintf(stderr, "Enter load file name\n");
   if (fgets(data, sizeof(data), stdin)) {
      char *lf = strchr(data, '\n');
      if (lf) {
         *lf = 0;
      }
      FILE *of = fopen(data, "r");
      if (of) {
         //free the old item list
         for (n = items; n; n = p) {
            p = n->next;
            free(n);
         }
         items = NULL;
         while (getline(&line, &sz, of) > 0) {
            temp = (item*)malloc(sizeof(item) + sz);
            strcpy(temp->data, line);
            free(line);
            temp->prev = NULL;
            temp->next = NULL;
            if (items == NULL) {
               items = n = temp;
            }
            else {
               n->next = temp;
               temp->prev = n;
               n = temp;
            }
            line = NULL;
            sz = 0;
         }
         fclose(of);
      }
      else {
         fprintf(stderr, "Failed to open file %s\n", data);
      }
   }
}

void _main() {
   char data[256];
   item *p, *n;
   item *temp;

   fprintf(stderr, "%s\n", WELCOME);
   
   while (1) {
      menu();
      if (fgets(data, sizeof(data), stdin) == 0) {
         break;
      }
      switch (*data) {
         case '1': //add
            add();
            break;
         case '2': //delete
            delete();
            break;
         case '3':  //list / print
            display();
            break;
         case '4': //replace / edit
            edit();
            break;
         case '5': //load
            load();
            break;
         case '6': //save
            save();
            break;
         case '7':
            exit(0);
            break;
      }
   }
   
   //lets free everything up
   for (n = items; n; n = p) {
      p = n->next;
      free(n);
   }
}

int main(int argc, char **argv) {
   setvbuf(stdin, NULL, _IONBF, 0);
   setvbuf(stdout, NULL, _IONBF, 0);
   setvbuf(stderr, NULL, _IONBF, 0);
   _main();
}
